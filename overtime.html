<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة الساعات الإضافية للموظفين</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .header p {
        font-size: 1.1em;
        opacity: 0.9;
    }

    .main-content {
        padding: 40px;
    }

    .upload-section {
        background: #f8f9fa;
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

    .upload-section:hover {
        border-color: #3498db;
        background: #e8f4f8;
    }

    .upload-section.dragover {
        border-color: #27ae60;
        background: #e8f5e8;
    }

    .upload-button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px;
    }

    .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .file-input {
        display: none;
    }

    .settings-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        display: none;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .setting-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .setting-card h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.2em;
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
    }

    .input-group input, .input-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
    }

    .input-group input:focus, .input-group select:focus {
        outline: none;
        border-color: #3498db;
    }

    .employee-rates {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .employee-rate-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
    }

    .employee-rate-item:hover {
        background: #f8f9fa;
    }

    .employee-rate-item:last-child {
        border-bottom: none;
    }

    .employee-name {
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }

    .rate-input {
        width: 150px;
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        text-align: center;
        font-size: 0.9em;
    }

    .calculate-button {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin: 20px auto;
    }

    .calculate-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .results-section {
        display: none;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-top: 30px;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-card h3 {
        font-size: 1.1em;
        color: #666;
        margin-bottom: 10px;
    }

    .summary-card .value {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
    }

    .summary-card.total .value {
        color: #27ae60;
    }

    .results-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .table-header {
        background: linear-gradient(135deg, #34495e, #2c3e50);
        color: white;
        padding: 20px;
        text-align: center;
    }

    .table-content {
        max-height: 600px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    tr:hover {
        background: #f8f9fa;
    }

    .overtime-hours {
        color: #e74c3c;
        font-weight: 600;
    }

    .overtime-pay {
        color: #27ae60;
        font-weight: 600;
    }

    .export-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    .export-button {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .loading::after {
        content: "";
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #f5c6cb;
    }

    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 20px;
        }
        
        .settings-grid {
            grid-template-columns: 1fr;
        }
        
        .summary-cards {
            grid-template-columns: 1fr;
        }
        
        .export-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        table {
            font-size: 0.9em;
        }
        
        th, td {
            padding: 10px 8px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>حاسبة الساعات الإضافية للموظفين</h1>
            <p>نظام شامل لحساب رواتب الساعات الإضافية من ملفات Excel و CSV</p>
        </div>

```
    <div class="main-content">
        <!-- قسم رفع الملف -->
        <div class="upload-section" id="uploadSection">
            <h2>📁 رفع ملف البيانات</h2>
            <p>اختر ملف Excel (.xlsx, .xls) أو CSV يحتوي على بيانات الموظفين</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
            <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                📁 اختيار ملف
            </button>
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                أو اسحب الملف وأفلته هنا
            </p>
        </div>

        <!-- قسم الإعدادات -->
        <div class="settings-section" id="settingsSection">
            <h2>⚙️ إعدادات الحساب</h2>
            <div class="settings-grid">
                <div class="setting-card">
                    <h3>إعدادات الوردية</h3>
                    <div class="input-group">
                        <label for="normalHours">ساعات العمل العادية (يومياً)</label>
                        <input type="number" id="normalHours" value="9" min="1" max="24" />
                    </div>
                    <div class="input-group">
                        <label for="overtimeMultiplier">مضاعف الساعات الإضافية</label>
                        <input type="number" id="overtimeMultiplier" value="1.5" min="1" max="5" step="0.1" readonly />
                        <small style="color: #666; font-size: 0.8em;">المضاعف ثابت 1.5 حسب النظام</small>
                    </div>
                </div>

                <div class="setting-card">
                    <h3>إعدادات أوقات العمل</h3>
                    <div class="input-group">
                        <label for="weekdayEndTime">وقت انتهاء العمل - أيام الأسبوع</label>
                        <input type="time" id="weekdayEndTime" value="02:15" />
                    </div>
                    <div class="input-group">
                        <label for="weekendEndTime">وقت انتهاء العمل - نهاية الأسبوع</label>
                        <input type="time" id="weekendEndTime" value="02:15" />
                    </div>
                    <div class="input-group">
                        <label for="weekendDays">أيام نهاية الأسبوع</label>
                        <select id="weekendDays">
                            <option value="thursday-friday" selected>الخميس والجمعة</option>
                            <option value="friday-saturday">الجمعة والسبت</option>
                            <option value="saturday-sunday">السبت والأحد</option>
                            <option value="friday-only">الجمعة فقط</option>
                            <option value="saturday-only">السبت فقط</option>
                            <option value="sunday-only">الأحد فقط</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="applyTimeAdjustment">
                            <input type="checkbox" id="applyTimeAdjustment" checked style="width: auto; margin-left: 10px;" />
                            تطبيق تعديل أوقات الخروج حسب نوع اليوم
                        </label>
                    </div>
                </div>

                <div class="setting-card">
                    <h3>إعدادات أيام الإجازة للموظفين</h3>
                    <div class="input-group">
                        <label for="holidayOvertimeMultiplier">مضاعف الساعات الإضافية في أيام الإجازة</label>
                        <input type="number" id="holidayOvertimeMultiplier" value="1.5" min="1" max="5" step="0.1" readonly />
                        <small style="color: #666; font-size: 0.8em;">المضاعف ثابت 1.5 حسب النظام</small>
                    </div>
                    <div class="input-group">
                        <label for="holidayMode">نظام حساب أيام الإجازة</label>
                        <select id="holidayMode">
                            <option value="full_overtime">كامل الوقت إضافي</option>
                            <option value="after_normal">إضافي بعد الساعات العادية</option>
                        </select>
                        <small style="color: #666; font-size: 0.8em;">
                            كامل الوقت إضافي: جميع الساعات في يوم الإجازة تحسب إضافية<br>
                            إضافي بعد الساعات العادية: الساعات الإضافة فقط بعد الساعات المحددة
                        </small>
                    </div>
                    <div class="input-group">
                        <label for="applyHolidayRules">
                            <input type="checkbox" id="applyHolidayRules" checked style="width: auto; margin-left: 10px;" />
                            تطبيق قواعد أيام الإجازة للموظفين
                        </label>
                    </div>
                    
                    <div class="employee-holidays" id="employeeHolidays">
                        <h4>أيام الإجازة لكل موظف</h4>
                        <div id="employeeHolidaysList">
                            <!-- سيتم ملء هذا القسم تلقائياً -->
                        </div>
                    </div>
                </div>

                <div class="setting-card">
                    <h3>إعدادات التاريخ</h3>
                    <div class="input-group">
                        <label for="dateRange">نطاق التاريخ</label>
                        <select id="dateRange">
                            <option value="all">جميع التواريخ</option>
                            <option value="month">الشهر الحالي</option>
                            <option value="custom">نطاق مخصص</option>
                        </select>
                    </div>
                    <div class="input-group" id="customDateRange" style="display: none;">
                        <label for="startDate">من تاريخ</label>
                        <input type="date" id="startDate" />
                        <label for="endDate">إلى تاريخ</label>
                        <input type="date" id="endDate" />
                    </div>
                </div>

                <div class="setting-card">
                    <h3>إعدادات الراتب</h3>
                    <div class="input-group">
                        <label for="currency">العملة</label>
                        <select id="currency">
                            <option value="SAR">ريال سعودي (SAR)</option>
                            <option value="USD">دولار أمريكي (USD)</option>
                            <option value="EUR">يورو (EUR)</option>
                            <option value="AED">درهم إماراتي (AED)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="defaultRate">سعر الساعة الافتراضي</label>
                        <input type="number" id="defaultRate" value="4.16" min="1" step="0.01" />
                    </div>
                </div>
            </div>

            <div class="employee-rates" id="employeeRates">
                <h3>أسعار الساعات الإضافية للموظفين</h3>
                <div id="employeeRatesList">
                    <!-- سيتم ملء هذا القسم تلقائياً -->
                </div>
            </div>

            <button class="calculate-button" onclick="calculateOvertime()">
                💰 حساب الساعات الإضافية
            </button>
        </div>

        <!-- قسم النتائج -->
        <div class="results-section" id="resultsSection">
            <h2>📊 تقرير الساعات الإضافية</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>إجمالي الموظفين</h3>
                    <div class="value" id="totalEmployees">0</div>
                </div>
                <div class="summary-card">
                    <h3>إجمالي الساعات الإضافية</h3>
                    <div class="value" id="totalOvertimeHours">0</div>
                </div>
                <div class="summary-card total">
                    <h3>إجمالي المبلغ المستحق</h3>
                    <div class="value" id="totalOvertimePay">0</div>
                </div>
            </div>

            <div class="results-table">
                <div class="table-header">
                    <h3>ملخص الساعات الإضافية لكل موظف</h3>
                </div>
                <div class="table-content">
                    <table id="summaryTable">
                        <thead>
                            <tr>
                                <th>اسم الموظف</th>
                                <th>عدد الورديات</th>
                                <th>ورديات عادية</th>
                                <th>ورديات إجازة</th>
                                <th>إجمالي الساعات الفعلية</th>
                                <th>إجمالي الساعات المعدلة</th>
                                <th>إجمالي الساعات الإضافية</th>
                                <th>سعر الساعة الإضافية</th>
                                <th>إجمالي المبلغ المستحق</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <!-- سيتم ملء هذا القسم تلقائياً -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="results-table" style="margin-top: 30px;">
                <div class="table-header">
                    <h3>تفاصيل الساعات الإضافية اليومية</h3>
                    <div class="table-controls">
                        <div class="filter-controls">
                            <input type="text" id="employeeFilter" placeholder="البحث بالاسم..." class="filter-input">
                            <select id="branchFilter" class="filter-select" style="display: none;">
                                <option value="">جميع الفروع</option>
                            </select>
                            <select id="dayTypeFilter" class="filter-select">
                                <option value="">جميع أنواع الأيام</option>
                                <option value="يوم عمل">أيام العمل</option>
                                <option value="نهاية الأسبوع">نهاية الأسبوع</option>
                                <option value="يوم إجازة">أيام الإجازة</option>
                            </select>
                            <input type="date" id="dateFromFilter" class="filter-input" placeholder="من تاريخ">
                            <input type="date" id="dateToFilter" class="filter-input" placeholder="إلى تاريخ">
                            <button onclick="clearFilters()" class="clear-filters-btn">مسح الفلاتر</button>
                            <button onclick="exportFilteredData()" class="export-filtered-btn">تصدير المفلتر</button>
                        </div>
                    </div>
                </div>
                <div class="table-content">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" class="sortable">اسم الموظف <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(1)" class="sortable">اسم اليوم <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(2)" class="sortable">التاريخ <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(3)" class="sortable">نوع اليوم <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(4)" class="sortable">وقت الحضور <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(5)" class="sortable">وقت الانصراف الأصلي <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(6)" class="sortable">وقت الانصراف المعدل <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(7)" class="sortable">الساعات الفعلية <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(8)" class="sortable">الساعات المعدلة <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(9)" class="sortable">الساعات الإضافية <span class="sort-icon">↕️</span></th>
                                <th onclick="sortTable(10)" class="sortable">مبلغ الساعات الإضافية <span class="sort-icon">↕️</span></th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- سيتم ملء هذا القسم تلقائياً -->
                        </tbody>
                    </table>
                </div>
                <div class="table-footer">
                    <div class="pagination-info">
                        <span id="tableInfo">عرض 0 من 0 سجل</span>
                    </div>
                </div>
            </div>

            <div class="export-buttons">
                <button class="export-button" onclick="exportToExcel()">
                    📄 تصدير التقرير المفصل إلى Excel
                </button>
                <button class="export-button" onclick="exportSummaryToExcel()">
                    📊 تصدير ملخص الموظفين إلى Excel
                </button>
                <button class="export-button" onclick="exportToCSV()">
                    📝 تصدير إلى CSV
                </button>
                <button class="export-button" onclick="printReport()">
                    🖨️ طباعة التقرير
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    let employeeData = [];
    let processedData = [];
    let filteredData = [];
    let currentSort = { column: -1, direction: 'asc' };

    // إعداد السحب والإفلات
    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');

    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('dragover');
    });

    uploadSection.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
    });

    uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // إعداد نطاق التاريخ المخصص
    document.getElementById('dateRange').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        if (this.value === 'custom') {
            customRange.style.display = 'block';
        } else {
            customRange.style.display = 'none';
        }
    });

    function handleFile(file) {
        const fileName = file.name.toLowerCase();
        const fileType = file.type;

        showLoading();

        if (fileName.endsWith('.csv') || fileType === 'text/csv') {
            handleCSVFile(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || 
                   fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                   fileType === 'application/vnd.ms-excel') {
            handleExcelFile(file);
        } else {
            showError('نوع الملف غير مدعوم. يرجى استخدام ملف Excel أو CSV.');
            hideLoading();
        }
    }

    function handleCSVFile(file) {
        Papa.parse(file, {
            header: true,
            encoding: 'UTF-8',
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors.length > 0) {
                    showError('خطأ في قراءة الملف: ' + results.errors[0].message);
                    hideLoading();
                    return;
                }
                
                processFileData(results.data);
                hideLoading();
            },
            error: function(error) {
                showError('خطأ في قراءة الملف: ' + error.message);
                hideLoading();
            }
        });
    }

    function handleExcelFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                processFileData(jsonData);
                hideLoading();
            } catch (error) {
                showError('خطأ في قراءة الملف: ' + error.message);
                hideLoading();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function processFileData(data) {
        if (!data || data.length === 0) {
            showError('الملف فارغ أو لا يحتوي على بيانات صالحة');
            return;
        }

        // تنظيف البيانات وتحويلها
        const rawData = data.map(row => {
            const keys = Object.keys(row);
            
            // البحث عن الأعمدة المطلوبة
            const nameKey = keys.find(k => k.includes('مستخدم') || k.includes('اسم') || k.includes('المستخدم'));
            const branchKey = keys.find(k => k.includes('فرع') || k.includes('الفرع'));
            const checkinKey = keys.find(k => k.includes('حضور') || k.includes('تسجيل الحضور'));
            const checkoutKey = keys.find(k => k.includes('انصراف') || k.includes('الإنصراف'));
            const durationKey = keys.find(k => k.includes('مدة') || k.includes('الوردية'));

            return {
                name: row[nameKey] || '',
                branch: row[branchKey] || '',
                checkin: row[checkinKey] || '',
                checkout: row[checkoutKey] || '',
                duration: row[durationKey] || ''
            };
        }).filter(row => row.name && row.name.trim() !== '');

        // تجميع التسجيلات المتعددة في اليوم الواحد
        const groupedData = {};
        rawData.forEach(row => {
            const date = parseArabicDate(row.checkin);
            const dateKey = `${row.name}_${date.toDateString()}`;
            
            if (!groupedData[dateKey]) {
                groupedData[dateKey] = [];
            }
            groupedData[dateKey].push(row);
        });

        // معالجة البيانات المجمعة
        employeeData = [];
        Object.values(groupedData).forEach(dayRecords => {
            if (dayRecords.length === 1) {
                // تسجيل واحد في اليوم
                employeeData.push(dayRecords[0]);
            } else {
                // تسجيلات متعددة - نأخذ الأقدم للدخول
                const sortedRecords = dayRecords.sort((a, b) => {
                    const timeA = parseArabicDateTime(a.checkin);
                    const timeB = parseArabicDateTime(b.checkin);
                    return timeA - timeB;
                });
                
                const earliestRecord = sortedRecords[0];
                employeeData.push(earliestRecord);
            }
        });

        if (employeeData.length === 0) {
            showError('لم يتم العثور على بيانات صالحة في الملف');
            return;
        }

        // عرض قسم الإعدادات
        document.getElementById('settingsSection').style.display = 'block';
        
        // إنشاء قائمة أسعار الموظفين
        createEmployeeRatesList();
        
        showSuccess(`تم تحميل بيانات ${employeeData.length} وردية بنجاح`);
    }

    function createEmployeeRatesList() {
        const employeeNames = [...new Set(employeeData.map(row => row.name))];
        const employeeRatesList = document.getElementById('employeeRatesList');
        const employeeHolidaysList = document.getElementById('employeeHolidaysList');
        
        // إنشاء قائمة أسعار الموظفين
        employeeRatesList.innerHTML = '';
        employeeHolidaysList.innerHTML = '';
        
        employeeNames.forEach(name => {
            // تحديد السعر الافتراضي حسب الاسم
            let defaultRate = 4.16; // القيمة الافتراضية
            if (name === 'ماهر عادل') {
                defaultRate = 10.41;
            } else if (name === 'أدهم' || name === 'Mohd Saber') {
                defaultRate = 4.16;
            }
            
            // عنصر السعر
            const rateItem = document.createElement('div');
            rateItem.className = 'employee-rate-item';
            rateItem.innerHTML = `
                <span class="employee-name">${name}</span>
                <input type="number" class="rate-input" value="${defaultRate}" min="1" step="0.01" 
                       data-employee="${name}" placeholder="سعر الساعة">
            `;
            employeeRatesList.appendChild(rateItem);
            
            // عنصر يوم الإجازة
            const holidayItem = document.createElement('div');
            holidayItem.className = 'employee-holiday-item';
            holidayItem.innerHTML = `
                <span class="employee-name">${name}</span>
                <select class="holiday-select" data-employee="${name}">
                    <option value="">لا يوجد يوم إجازة</option>
                    <option value="0">الأحد</option>
                    <option value="1">الاثنين</option>
                    <option value="2">الثلاثاء</option>
                    <option value="3">الأربعاء</option>
                    <option value="4">الخميس</option>
                    <option value="5">الجمعة</option>
                    <option value="6">السبت</option>
                </select>
            `;
            employeeHolidaysList.appendChild(holidayItem);
        });
    }

    function calculateOvertime() {
        if (employeeData.length === 0) {
            showError('يرجى رفع ملف البيانات أولاً');
            return;
        }

        const normalHours = parseFloat(document.getElementById('normalHours').value);
        const overtimeMultiplier = parseFloat(document.getElementById('overtimeMultiplier').value);
        const currency = document.getElementById('currency').value;
        const applyTimeAdjustment = document.getElementById('applyTimeAdjustment').checked;
        const weekdayEndTime = document.getElementById('weekdayEndTime').value;
        const weekendEndTime = document.getElementById('weekendEndTime').value;
        const weekendDays = document.getElementById('weekendDays').value;
        const applyHolidayRules = document.getElementById('applyHolidayRules').checked;
        const holidayOvertimeMultiplier = 1.5; // ثابت
        const holidayMode = document.getElementById('holidayMode').value;
        
        // جمع أسعار الموظفين
        const employeeRates = {};
        document.querySelectorAll('.rate-input').forEach(input => {
            const employeeName = input.getAttribute('data-employee');
            employeeRates[employeeName] = parseFloat(input.value) || 0;
        });
        
        // جمع أيام الإجازة للموظفين
        const employeeHolidays = {};
        document.querySelectorAll('.holiday-select').forEach(select => {
            const employeeName = select.getAttribute('data-employee');
            const holidayDay = select.value;
            if (holidayDay !== '') {
                employeeHolidays[employeeName] = parseInt(holidayDay);
            }
        });

        // تحويل بيانات الورديات مع تطبيق تعديل الأوقات
        processedData = [];
        
        employeeData.forEach(row => {
            const shiftDate = parseArabicDate(row.checkin);
            const dayOfWeek = shiftDate.getDay();
            const isWeekend = isWeekendDay(shiftDate, weekendDays);
            const isHoliday = applyHolidayRules && employeeHolidays[row.name] === dayOfWeek;
            
            let dayType = 'يوم عمل';
            if (isHoliday) {
                dayType = 'يوم إجازة';
            } else if (isWeekend) {
                dayType = 'نهاية الأسبوع';
            }
            
            const originalDuration = parseDuration(row.duration);
            let adjustedDuration = originalDuration;
            let adjustedCheckout = row.checkout;
            let overtimeHours = 0;
            let usedMultiplier = 1.5; // ثابت دائماً
            
            // حساب وقت الانصراف المعدل (دائماً 2:15)
            if (applyTimeAdjustment) {
                const checkinTime = parseArabicDateTime(row.checkin);
                const targetEndTime = "02:15"; // ثابت لجميع الأيام
                const adjustedCheckoutTime = calculateAdjustedCheckout(checkinTime, targetEndTime, normalHours);
                
                adjustedCheckout = formatArabicDateTime(adjustedCheckoutTime);
                adjustedDuration = calculateHoursBetween(checkinTime, adjustedCheckoutTime);
            }
            
            if (isHoliday && applyHolidayRules) {
                // حساب أيام الإجازة
                if (holidayMode === 'full_overtime') {
                    // كامل الوقت إضافي
                    overtimeHours = adjustedDuration; // استخدم الوقت المعدل
                } else {
                    // إضافي بعد الساعات العادية
                    overtimeHours = Math.max(0, adjustedDuration - normalHours);
                }
            } else {
                // حساب أيام العمل العادية ونهاية الأسبوع
                overtimeHours = Math.max(0, adjustedDuration - normalHours);
            }
            
            const rate = employeeRates[row.name] || 0;
            const overtimePay = overtimeHours * rate * usedMultiplier;
            
            processedData.push({
                name: row.name,
                branch: row.branch,
                date: formatDateForDisplay(shiftDate),
                dayName: getDayName(shiftDate),
                dayType: dayType,
                checkin: row.checkin,
                originalCheckout: row.checkout,
                adjustedCheckout: adjustedCheckout,
                originalDuration: originalDuration,
                adjustedDuration: adjustedDuration,
                overtimeHours: overtimeHours,
                overtimePay: overtimePay,
                rate: rate,
                currency: currency,
                multiplier: usedMultiplier,
                isHoliday: isHoliday
            });
        });

        displayResults();
    }

    function isWeekendDay(date, weekendDays) {
        const dayOfWeek = date.getDay(); // 0 = الأحد, 1 = الاثنين, ..., 6 = السبت
        
        switch (weekendDays) {
            case 'thursday-friday':
                return dayOfWeek === 4 || dayOfWeek === 5; // الخميس والجمعة
            case 'friday-saturday':
                return dayOfWeek === 5 || dayOfWeek === 6; // الجمعة والسبت
            case 'saturday-sunday':
                return dayOfWeek === 6 || dayOfWeek === 0; // السبت والأحد
            case 'friday-only':
                return dayOfWeek === 5; // الجمعة فقط
            case 'saturday-only':
                return dayOfWeek === 6; // السبت فقط
            case 'sunday-only':
                return dayOfWeek === 0; // الأحد فقط
            default:
                return false;
        }
    }

    function parseArabicDate(arabicDateStr) {
        // تحويل التاريخ العربي إلى كائن Date
        const months = {
            'يناير': 0, 'فبراير': 1, 'مارس': 2, 'أبريل': 3, 'مايو': 4, 'يونيو': 5,
            'يوليو': 6, 'أغسطس': 7, 'سبتمبر': 8, 'أكتوبر': 9, 'نوفمبر': 10, 'ديسمبر': 11
        };
        
        // استخراج الشهر واليوم من النص العربي
        const parts = arabicDateStr.split('، ')[0].split(' ');
        const monthName = parts[0];
        const day = parseInt(parts[1]);
        const year = new Date().getFullYear(); // افتراض السنة الحالية
        
        return new Date(year, months[monthName] || 0, day);
    }

    function parseArabicDateTime(arabicDateTimeStr) {
        const parts = arabicDateTimeStr.split('، ');
        const datePart = parts[0];
        const timePart = parts[1];
        
        const date = parseArabicDate(arabicDateTimeStr);
        
        // تحويل الوقت
        let hours, minutes;
        if (timePart.includes('ص')) {
            const time = timePart.replace('ص', '').trim().split(':');
            hours = parseInt(time[0]);
            minutes = parseInt(time[1]) || 0;
            if (hours === 12) hours = 0; // 12 ص = منتصف الليل
        } else if (timePart.includes('م')) {
            const time = timePart.replace('م', '').trim().split(':');
            hours = parseInt(time[0]);
            minutes = parseInt(time[1]) || 0;
            if (hours !== 12) hours += 12; // تحويل إلى نظام 24 ساعة
        }
        
        date.setHours(hours, minutes, 0, 0);
        return date;
    }

    function calculateAdjustedCheckout(checkinTime, targetEndTime, normalHours) {
        const [targetHours, targetMinutes] = targetEndTime.split(':').map(Number);
        
        // إنشاء وقت الانصراف المستهدف (دائماً 2:15)
        const targetCheckout = new Date(checkinTime);
        targetCheckout.setHours(targetHours, targetMinutes, 0, 0);
        
        // إذا كان وقت الانصراف المستهدف قبل وقت الحضور، فهو في اليوم التالي
        if (targetCheckout <= checkinTime) {
            targetCheckout.setDate(targetCheckout.getDate() + 1);
        }
        
        // دائماً نعيد 2:15 بغض النظر عن ساعات العمل العادية
        return targetCheckout;
    }

    function calculateHoursBetween(startTime, endTime) {
        const diffMs = endTime - startTime;
        return Math.max(0, diffMs / (1000 * 60 * 60)); // تحويل إلى ساعات
    }

    function formatArabicDateTime(date) {
        const months = [
            'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
        ];
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = months[date.getMonth()];
        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        
        let displayHours = hours;
        let period = 'ص';
        
        if (hours === 0) {
            displayHours = 12;
            period = 'ص';
        } else if (hours === 12) {
            displayHours = 12;
            period = 'م';
        } else if (hours > 12) {
            displayHours = hours - 12;
            period = 'م';
        }
        
        return `${month} ${day}، ${displayHours}:${minutes}${period}`;
    }

    function formatDateForDisplay(date) {
        const months = [
            'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
        ];
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        
        return `${day} ${month} ${year}`;
    }

    function getDayName(date) {
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        return days[date.getDay()];
    }

    function formatDuration(hours) {
        const totalMinutes = Math.round(hours * 60);
        const hrs = Math.floor(totalMinutes / 60);
        const mins = totalMinutes % 60;
        return `${hrs}:${mins.toString().padStart(2, '0')}`;
    }

    function parseDuration(durationStr) {
        if (!durationStr) return 0;
        
        const parts = durationStr.split(':');
        if (parts.length === 2) {
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            return hours + (minutes / 60);
        }
        
        return 0;
    }

    function displayResults() {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.style.display = 'block';

        // حساب الملخص العام
        const totalEmployees = [...new Set(processedData.map(row => row.name))].length;
        const totalOvertimeHours = processedData.reduce((sum, row) => sum + row.overtimeHours, 0);
        const totalOvertimePay = processedData.reduce((sum, row) => sum + row.overtimePay, 0);
        const currency = document.getElementById('currency').value;

        // عرض الملخص العام
        document.getElementById('totalEmployees').textContent = totalEmployees;
        document.getElementById('totalOvertimeHours').textContent = totalOvertimeHours.toFixed(2);
        document.getElementById('totalOvertimePay').textContent = formatCurrency(totalOvertimePay, currency);

        // حساب إجمالي كل موظف
        const employeeSummary = {};
        processedData.forEach(row => {
            if (!employeeSummary[row.name]) {
                employeeSummary[row.name] = {
                    name: row.name,
                    branch: row.branch,
                    shiftsCount: 0,
                    normalShifts: 0,
                    holidayShifts: 0,
                    totalOriginalHours: 0,
                    totalAdjustedHours: 0,
                    totalOvertimeHours: 0,
                    totalOvertimePay: 0,
                    rate: row.rate
                };
            }
            
            employeeSummary[row.name].shiftsCount += 1;
            if (row.isHoliday) {
                employeeSummary[row.name].holidayShifts += 1;
            } else {
                employeeSummary[row.name].normalShifts += 1;
            }
            employeeSummary[row.name].totalOriginalHours += row.originalDuration;
            employeeSummary[row.name].totalAdjustedHours += row.adjustedDuration;
            employeeSummary[row.name].totalOvertimeHours += row.overtimeHours;
            employeeSummary[row.name].totalOvertimePay += row.overtimePay;
        });

        // عرض جدول الملخص للموظفين
        const summaryTableBody = document.getElementById('summaryTableBody');
        summaryTableBody.innerHTML = '';

        Object.values(employeeSummary).forEach(emp => {
            const summaryRow = document.createElement('tr');
            summaryRow.innerHTML = `
                <td><strong>${emp.name}</strong></td>
                <td>${emp.shiftsCount}</td>
                <td>${emp.normalShifts}</td>
                <td class="holiday-shifts">${emp.holidayShifts}</td>
                <td>${formatDuration(emp.totalOriginalHours)}</td>
                <td class="adjusted-hours">${formatDuration(emp.totalAdjustedHours)}</td>
                <td class="overtime-hours">${formatDuration(emp.totalOvertimeHours)}</td>
                <td>${formatCurrency(emp.rate, currency)}</td>
                <td class="overtime-pay"><strong>${formatCurrency(emp.totalOvertimePay, currency)}</strong></td>
            `;
            summaryTableBody.appendChild(summaryRow);
        });

        // عرض جدول التفاصيل اليومية
        filteredData = [...processedData];
        setupTableFilters();
        displayTableData();

        // إضافة CSS للعناصر الجديدة
        if (!document.getElementById('dynamicStyles')) {
            const style = document.createElement('style');
            style.id = 'dynamicStyles';
            style.textContent = `
                .day-type {
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                    font-weight: bold;
                }
                .day-type.weekday {
                    background: #e3f2fd;
                    color: #1976d2;
                }
                .day-type.weekend {
                    background: #fce4ec;
                    color: #c2185b;
                }
                
                .day-type.holiday {
                    background: #fff3e0;
                    color: #f57c00;
                    border: 1px solid #ffb74d;
                }
                .adjusted-time {
                    background: #f0f8ff;
                    font-weight: 600;
                    color: #2c5aa0;
                }
                .adjusted-hours {
                    background: #f0f8ff;
                    font-weight: 600;
                    color: #2c5aa0;
                }
                #summaryTable tbody tr {
                    background: #f8f9fa;
                    border-left: 4px solid #3498db;
                }
                #summaryTable tbody tr:hover {
                    background: #e9ecef;
                }
                
                .holiday-shifts {
                    background: #fff3e0;
                    color: #f57c00;
                    font-weight: bold;
                }
                
                .employee-holidays {
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    margin-top: 20px;
                    border: 2px solid #e3f2fd;
                }
                
                .employee-holiday-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 15px;
                    border-bottom: 1px solid #eee;
                    transition: background-color 0.3s ease;
                }
                
                .employee-holiday-item:hover {
                    background: #f8f9fa;
                }
                
                .employee-holiday-item:last-child {
                    border-bottom: none;
                }
                
                .multiplier-value {
                    background: #e8f5e8;
                    color: #2e7d32;
                    font-weight: bold;
                    text-align: center;
                }
                
                .table-controls {
                    background: white;
                    padding: 15px;
                    border-bottom: 1px solid #dee2e6;
                }
                
                .filter-controls {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                    align-items: center;
                }
                
                .filter-input, .filter-select {
                    padding: 8px 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 6px;
                    font-size: 0.9em;
                    min-width: 120px;
                }
                
                .filter-input:focus, .filter-select:focus {
                    outline: none;
                    border-color: #3498db;
                }
                
                .clear-filters-btn, .export-filtered-btn {
                    background: linear-gradient(135deg, #e74c3c, #c0392b);
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                }
                
                .export-filtered-btn {
                    background: linear-gradient(135deg, #16a085, #1abc9c);
                }
                
                .clear-filters-btn:hover, .export-filtered-btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                }
                
                .sortable {
                    cursor: pointer;
                    user-select: none;
                    position: relative;
                    transition: background-color 0.3s ease;
                }
                
                .sortable:hover {
                    background: #e9ecef;
                }
                
                .sort-icon {
                    font-size: 0.8em;
                    margin-right: 5px;
                    opacity: 0.6;
                }
                
                .sortable.asc .sort-icon::after {
                    content: "↑";
                    color: #3498db;
                    font-weight: bold;
                }
                
                .sortable.desc .sort-icon::after {
                    content: "↓";
                    color: #3498db;
                    font-weight: bold;
                }
                
                .table-footer {
                    background: #f8f9fa;
                    padding: 10px 15px;
                    border-top: 1px solid #dee2e6;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .pagination-info {
                    font-size: 0.9em;
                    color: #666;
                }
                
                .filtered-row {
                    animation: fadeIn 0.3s ease;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                .no-results {
                    text-align: center;
                    padding: 40px;
                    color: #666;
                    font-style: italic;
                }
                
                @media (max-width: 768px) {
                    .filter-controls {
                        flex-direction: column;
                        align-items: stretch;
                    }
                    
                    .filter-input, .filter-select {
                        min-width: auto;
                        width: 100%;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // التمرير إلى النتائج
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    function formatCurrency(amount, currency) {
        const symbols = {
            'SAR': 'ر.س',
            'USD': '$',
            'EUR': '€',
            'AED': 'د.إ'
        };
        
        return `${amount.toFixed(2)} ${symbols[currency] || currency}`;
    }

    function exportToExcel() {
        if (processedData.length === 0) {
            showError('لا توجد بيانات للتصدير');
            return;
        }

        const currency = document.getElementById('currency').value;
        const ws_data = [
            ['اسم الموظف', 'الفرع', 'التاريخ', 'نوع اليوم', 'وقت الحضور', 'وقت الانصراف الأصلي', 'وقت الانصراف المعدل', 'الساعات الفعلية', 'الساعات المعدلة', 'الساعات الإضافية', 'مبلغ الساعات الإضافية'],
            ...processedData.map(row => [
                row.name,
                row.branch,
                row.date,
                row.dayType,
                row.checkin,
                row.originalCheckout,
                row.adjustedCheckout,
                row.originalDuration.toFixed(2),
                row.adjustedDuration.toFixed(2),
                row.overtimeHours.toFixed(2),
                row.overtimePay.toFixed(2)
            ])
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // تنسيق العمود
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const address = XLSX.utils.encode_col(C) + "1";
            if (!ws[address]) continue;
            ws[address].s = {
                font: { bold: true },
                alignment: { horizontal: "center" }
            };
        }

        XLSX.utils.book_append_sheet(wb, ws, "تقرير الساعات الإضافية المفصل");
        XLSX.writeFile(wb, `تقرير_الساعات_الإضافية_مفصل_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportToCSV() {
        if (processedData.length === 0) {
            showError('لا توجد بيانات للتصدير');
            return;
        }

        const csvContent = [
            ['اسم الموظف', 'الفرع', 'التاريخ', 'نوع اليوم', 'وقت الحضور', 'وقت الانصراف الأصلي', 'وقت الانصراف المعدل', 'الساعات الفعلية', 'الساعات المعدلة', 'الساعات الإضافية', 'مبلغ الساعات الإضافية'],
            ...processedData.map(row => [
                row.name,
                row.branch,
                row.date,
                row.dayType,
                row.checkin,
                row.originalCheckout,
                row.adjustedCheckout,
                row.originalDuration.toFixed(2),
                row.adjustedDuration.toFixed(2),
                row.overtimeHours.toFixed(2),
                row.overtimePay.toFixed(2)
            ])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `تقرير_الساعات_الإضافية_مفصل_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportSummaryToExcel() {
        if (processedData.length === 0) {
            showError('لا توجد بيانات للتصدير');
            return;
        }

        // حساب إجمالي كل موظف
        const employeeSummary = {};
        processedData.forEach(row => {
            if (!employeeSummary[row.name]) {
                employeeSummary[row.name] = {
                    name: row.name,
                    branch: row.branch,
                    shiftsCount: 0,
                    totalOriginalHours: 0,
                    totalAdjustedHours: 0,
                    totalOvertimeHours: 0,
                    totalOvertimePay: 0,
                    rate: row.rate
                };
            }
            
            employeeSummary[row.name].shiftsCount += 1;
            employeeSummary[row.name].totalOriginalHours += row.originalDuration;
            employeeSummary[row.name].totalAdjustedHours += row.adjustedDuration;
            employeeSummary[row.name].totalOvertimeHours += row.overtimeHours;
            employeeSummary[row.name].totalOvertimePay += row.overtimePay;
        });

        const ws_data = [
            ['اسم الموظف', 'الفرع', 'عدد الورديات', 'إجمالي الساعات الفعلية', 'إجمالي الساعات المعدلة', 'إجمالي الساعات الإضافية', 'سعر الساعة الإضافية', 'إجمالي المبلغ المستحق'],
            ...Object.values(employeeSummary).map(emp => [
                emp.name,
                emp.branch,
                emp.shiftsCount,
                emp.totalOriginalHours.toFixed(2),
                emp.totalAdjustedHours.toFixed(2),
                emp.totalOvertimeHours.toFixed(2),
                emp.rate.toFixed(2),
                emp.totalOvertimePay.toFixed(2)
            ])
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // تنسيق العمود
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const address = XLSX.utils.encode_col(C) + "1";
            if (!ws[address]) continue;
            ws[address].s = {
                font: { bold: true },
                alignment: { horizontal: "center" }
            };
        }

        XLSX.utils.book_append_sheet(wb, ws, "ملخص الموظفين");
        XLSX.writeFile(wb, `ملخص_الساعات_الإضافية_للموظفين_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function setupTableFilters() {
        // إعداد فلتر الفروع
        const branches = [...new Set(processedData.map(row => row.branch))];
        const branchFilter = document.getElementById('branchFilter');
        branchFilter.innerHTML = '<option value="">جميع الفروع</option>';
        branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            branchFilter.appendChild(option);
        });

        // إضافة مستمعي الأحداث للفلاتر
        document.getElementById('employeeFilter').addEventListener('input', applyFilters);
        document.getElementById('branchFilter').addEventListener('change', applyFilters);
        document.getElementById('dayTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
        document.getElementById('dateToFilter').addEventListener('change', applyFilters);
    }

    function applyFilters() {
        const employeeFilter = document.getElementById('employeeFilter').value.toLowerCase();
        const branchFilter = document.getElementById('branchFilter').value;
        const dayTypeFilter = document.getElementById('dayTypeFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;
        const dateToFilter = document.getElementById('dateToFilter').value;

        filteredData = processedData.filter(row => {
            // فلتر الاسم
            const nameMatch = !employeeFilter || row.name.toLowerCase().includes(employeeFilter);
            
            // فلتر الفرع
            const branchMatch = !branchFilter || row.branch === branchFilter;
            
            // فلتر نوع اليوم
            const dayTypeMatch = !dayTypeFilter || row.dayType === dayTypeFilter;
            
            // فلتر التاريخ
            let dateMatch = true;
            if (dateFromFilter || dateToFilter) {
                const rowDate = parseDisplayDate(row.date);
                if (dateFromFilter) {
                    const fromDate = new Date(dateFromFilter);
                    dateMatch = dateMatch && (rowDate >= fromDate);
                }
                if (dateToFilter) {
                    const toDate = new Date(dateToFilter);
                    dateMatch = dateMatch && (rowDate <= toDate);
                }
            }
            
            return nameMatch && branchMatch && dayTypeMatch && dateMatch;
        });

        displayTableData();
        updateTableInfo();
    }

    function parseDisplayDate(dateStr) {
        // تحويل التاريخ من النص العربي إلى كائن Date
        const months = {
            'يناير': 0, 'فبراير': 1, 'مارس': 2, 'أبريل': 3, 'مايو': 4, 'يونيو': 5,
            'يوليو': 6, 'أغسطس': 7, 'سبتمبر': 8, 'أكتوبر': 9, 'نوفمبر': 10, 'ديسمبر': 11
        };
        
        const parts = dateStr.split(' ');
        const day = parseInt(parts[0]);
        const month = months[parts[1]];
        const year = parseInt(parts[2]);
        
        return new Date(year, month, day);
    }

    function clearFilters() {
        document.getElementById('employeeFilter').value = '';
        document.getElementById('branchFilter').value = '';
        document.getElementById('dayTypeFilter').value = '';
        document.getElementById('dateFromFilter').value = '';
        document.getElementById('dateToFilter').value = '';
        
        filteredData = [...processedData];
        displayTableData();
        updateTableInfo();
        
        // إعادة تعيين الترتيب
        currentSort = { column: -1, direction: 'asc' };
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });
    }

    function displayTableData() {
        const tableBody = document.getElementById('resultsTableBody');
        const currency = document.getElementById('currency').value;
        
        if (filteredData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="11" class="no-results">لا توجد نتائج تطابق الفلاتر المحددة</td></tr>';
            return;
        }

        tableBody.innerHTML = '';
        filteredData.forEach(row => {
            const tableRow = document.createElement('tr');
            tableRow.className = 'filtered-row';
            
            let dayTypeClass = 'weekday';
            if (row.dayType === 'نهاية الأسبوع') dayTypeClass = 'weekend';
            if (row.dayType === 'يوم إجازة') dayTypeClass = 'holiday';
            
            tableRow.innerHTML = `
                <td>${row.name}</td>
                <td>${row.dayName}</td>
                <td>${row.date}</td>
                <td><span class="day-type ${dayTypeClass}">${row.dayType}</span></td>
                <td>${row.checkin}</td>
                <td>${row.originalCheckout}</td>
                <td class="adjusted-time">${row.adjustedCheckout}</td>
                <td>${formatDuration(row.originalDuration)}</td>
                <td class="adjusted-hours">${formatDuration(row.adjustedDuration)}</td>
                <td class="overtime-hours">${formatDuration(row.overtimeHours)}</td>
                <td class="overtime-pay">${formatCurrency(row.overtimePay, currency)}</td>
            `;
            tableBody.appendChild(tableRow);
        });
    }

    function updateTableInfo() {
        const totalRecords = processedData.length;
        const filteredRecords = filteredData.length;
        const infoText = `عرض ${filteredRecords} من ${totalRecords} سجل`;
        document.getElementById('tableInfo').textContent = infoText;
    }

    function sortTable(columnIndex) {
        const headers = document.querySelectorAll('.sortable');
        
        // إزالة الكلاسات السابقة
        headers.forEach(header => header.classList.remove('asc', 'desc'));
        
        // تحديد اتجاه الترتيب
        if (currentSort.column === columnIndex) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.direction = 'asc';
        }
        currentSort.column = columnIndex;
        
        // إضافة الكلاس الجديد
        headers[columnIndex].classList.add(currentSort.direction);
        
        // ترتيب البيانات
        filteredData.sort((a, b) => {
            let valueA, valueB;
            
            switch (columnIndex) {
                case 0: // اسم الموظف
                    valueA = a.name;
                    valueB = b.name;
                    break;
                case 1: // الفرع
                    valueA = a.branch;
                    valueB = b.branch;
                    break;
                case 2: // التاريخ
                    valueA = parseDisplayDate(a.date);
                    valueB = parseDisplayDate(b.date);
                    break;
                case 3: // نوع اليوم
                    valueA = a.dayType;
                    valueB = b.dayType;
                    break;
                case 4: // وقت الحضور
                    valueA = a.checkin;
                    valueB = b.checkin;
                    break;
                case 5: // وقت الانصراف الأصلي
                    valueA = a.originalCheckout;
                    valueB = b.originalCheckout;
                    break;
                case 6: // وقت الانصراف المعدل
                    valueA = a.adjustedCheckout;
                    valueB = b.adjustedCheckout;
                    break;
                case 7: // الساعات الفعلية
                    valueA = a.originalDuration;
                    valueB = b.originalDuration;
                    break;
                case 8: // الساعات المعدلة
                    valueA = a.adjustedDuration;
                    valueB = b.adjustedDuration;
                    break;
                case 9: // الساعات الإضافية
                    valueA = a.overtimeHours;
                    valueB = b.overtimeHours;
                    break;
                case 10: // المضاعف المطبق
                    valueA = a.multiplier;
                    valueB = b.multiplier;
                    break;
                case 11: // مبلغ الساعات الإضافية
                    valueA = a.overtimePay;
                    valueB = b.overtimePay;
                    break;
                default:
                    return 0;
            }
            
            if (typeof valueA === 'string' && typeof valueB === 'string') {
                valueA = valueA.toLowerCase();
                valueB = valueB.toLowerCase();
            }
            
            if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        displayTableData();
    }

    function exportFilteredData() {
        if (filteredData.length === 0) {
            showError('لا توجد بيانات مفلترة للتصدير');
            return;
        }

        const ws_data = [
            ['اسم الموظف', 'الفرع', 'التاريخ', 'نوع اليوم', 'وقت الحضور', 'وقت الانصراف الأصلي', 'وقت الانصراف المعدل', 'الساعات الفعلية', 'الساعات المعدلة', 'الساعات الإضافية', 'مبلغ الساعات الإضافية'],
            ...filteredData.map(row => [
                row.name,
                row.branch,
                row.date,
                row.dayType,
                row.checkin,
                row.originalCheckout,
                row.adjustedCheckout,
                row.originalDuration.toFixed(2),
                row.adjustedDuration.toFixed(2),
                row.overtimeHours.toFixed(2),
                row.overtimePay.toFixed(2)
            ])
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // تنسيق العمود
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const address = XLSX.utils.encode_col(C) + "1";
            if (!ws[address]) continue;
            ws[address].s = {
                font: { bold: true },
                alignment: { horizontal: "center" }
            };
        }

        XLSX.utils.book_append_sheet(wb, ws, "البيانات المفلترة");
        XLSX.writeFile(wb, `البيانات_المفلترة_${new Date().toISOString().split('T')[0]}.xlsx`);
        
        showSuccess(`تم تصدير ${filteredData.length} سجل بنجاح`);
    }

    function printReport() {
        if (processedData.length === 0) {
            showError('لا توجد بيانات للطباعة');
            return;
        }

        const currency = document.getElementById('currency').value;
        const totalEmployees = processedData.length;
        const totalOvertimeHours = processedData.reduce((sum, emp) => sum + emp.overtimeHours, 0);
        const totalOvertimePay = processedData.reduce((sum, emp) => sum + emp.overtimePay, 0);

        const printContent = `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>تقرير الساعات الإضافية</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .summary { display: flex; justify-content: space-around; margin-bottom: 30px; }
                    .summary-item { text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                    .overtime-hours { color: #e74c3c; font-weight: bold; }
                    .overtime-pay { color: #27ae60; font-weight: bold; }
                    @media print { 
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>تقرير الساعات الإضافية للموظفين</h1>
                    <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                
                <div class="summary">
                    <div class="summary-item">
                        <h3>إجمالي الموظفين</h3>
                        <p>${totalEmployees}</p>
                    </div>
                    <div class="summary-item">
                        <h3>إجمالي الساعات الإضافية</h3>
                        <p>${totalOvertimeHours.toFixed(2)}</p>
                    </div>
                    <div class="summary-item">
                        <h3>إجمالي المبلغ المستحق</h3>
                        <p>${formatCurrency(totalOvertimePay, currency)}</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>اسم الموظف</th>
                            <th>الفرع</th>
                            <th>إجمالي الساعات</th>
                            <th>الساعات العادية</th>
                            <th>الساعات الإضافية</th>
                            <th>سعر الساعة الإضافية</th>
                            <th>مبلغ الساعات الإضافية</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processedData.map(emp => `
                            <tr>
                                <td>${emp.name}</td>
                                <td>${emp.branch}</td>
                                <td>${emp.totalHours.toFixed(2)}</td>
                                <td>${emp.regularHours.toFixed(2)}</td>
                                <td class="overtime-hours">${emp.overtimeHours.toFixed(2)}</td>
                                <td>${formatCurrency(emp.rate, currency)}</td>
                                <td class="overtime-pay">${formatCurrency(emp.overtimePay, currency)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </body>
            </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    }

    function showLoading() {
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.innerHTML = '<div class="loading">جاري تحميل الملف...</div>';
    }

    function hideLoading() {
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.innerHTML = `
            <h2>📁 رفع ملف البيانات</h2>
            <p>اختر ملف Excel (.xlsx, .xls) أو CSV يحتوي على بيانات الموظفين</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
            <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                📁 اختيار ملف
            </button>
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                أو اسحب الملف وأفلته هنا
            </p>
        `;
        
        // إعادة إعداد مستمعي الأحداث
        const newFileInput = document.getElementById('fileInput');
        newFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
    }

    function showError(message) {
        const existing = document.querySelector('.error');
        if (existing) existing.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        document.querySelector('.main-content').appendChild(errorDiv);
        
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
        const existing = document.querySelector('.success');
        if (existing) existing.remove();
        
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        document.querySelector('.main-content').appendChild(successDiv);
        
        setTimeout(() => successDiv.remove(), 5000);
    }

    // تحديث سعر الساعة الافتراضي لجميع الموظفين
    document.getElementById('defaultRate').addEventListener('input', function() {
        const newRate = this.value;
        document.querySelectorAll('.rate-input').forEach(input => {
            if (input.value === '' || input.value === '0') {
                input.value = newRate;
            }
        });
    });

    // إعداد تواريخ افتراضية للنطاق المخصص
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('startDate').valueAsDate = firstDay;
    document.getElementById('endDate').valueAsDate = today;

    // تحميل بيانات نموذجية للاختبار
    function loadSampleData() {
        const sampleData = [
            {
                name: 'ماهر عادل',
                branch: 'الهفوف',
                checkin: 'يونيو 02، 02:29م',
                checkout: 'يونيو 03، 02:25ص',
                duration: '11:55'
            },
            {
                name: 'Mohd Saber',
                branch: 'الهفوف',
                checkin: 'يونيو 10، 02:53م',
                checkout: 'يونيو 11، 02:37ص',
                duration: '11:43'
            },
            {
                name: 'أدهم',
                branch: 'الهفوف',
                checkin: 'يونيو 16، 02:42م',
                checkout: 'يونيو 17، 02:49ص',
                duration: '12:06'
            }
        ];

        employeeData = sampleData;
        document.getElementById('settingsSection').style.display = 'block';
        createEmployeeRatesList();
        showSuccess('تم تحميل بيانات نموذجية للاختبار');
    }

    // إضافة زر لتحميل البيانات النموذجية للاختبار
    setTimeout(() => {
        const uploadSection = document.getElementById('uploadSection');
        const testButton = document.createElement('button');
        testButton.className = 'upload-button';
        testButton.textContent = '🧪 تحميل بيانات نموذجية للاختبار';
        testButton.onclick = loadSampleData;
        uploadSection.appendChild(testButton);
    }, 1000);
</script>
```

</body>
</html>